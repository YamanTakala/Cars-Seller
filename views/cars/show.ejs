<%- include('../partials/header') %>

<div class="container py-4">
    <% if (car) { %>
        <div class="row">
            <!-- Car Images Gallery -->
            <div class="col-lg-8">
                <div id="carCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <% if (car.images && car.images.length > 0) { %>
                            <% car.images.forEach(function(image, index) { %>
                                <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                                    <img src="<%= image.url %>" class="d-block w-100 rounded" style="height: 400px; object-fit: cover;" alt="<%= car.title %>">
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="carousel-item active">
                                <div class="d-block w-100 bg-light rounded d-flex align-items-center justify-content-center" style="height: 400px;">
                                    <i class="fas fa-car fa-5x text-muted"></i>
                                </div>
                            </div>
                        <% } %>
                    </div>
                    
                    <% if (car.images && car.images.length > 1) { %>
                        <button class="carousel-control-prev" type="button" data-bs-target="#carCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    <% } %>
                </div>
                
                <!-- Car Details -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0"><%= car.title %></h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted">المواصفات الأساسية</h6>
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>الماركة:</strong></td>
                                        <td><%= car.brand %></td>
                                    </tr>
                                    <tr>
                                        <td><strong>الموديل:</strong></td>
                                        <td><%= car.model %></td>
                                    </tr>
                                    <tr>
                                        <td><strong>السنة:</strong></td>
                                        <td><%= car.year %></td>
                                    </tr>
                                    <tr>
                                        <td><strong>المسافة المقطوعة:</strong></td>
                                        <td><%= new Intl.NumberFormat('ar-SA').format(car.mileage) %> كم</td>
                                    </tr>
                                    <tr>
                                        <td><strong>نوع الوقود:</strong></td>
                                        <td><%= car.fuelType %></td>
                                    </tr>
                                    <tr>
                                        <td><strong>ناقل الحركة:</strong></td>
                                        <td><%= car.transmission %></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">معلومات إضافية</h6>
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>الحالة:</strong></td>
                                        <td>
                                            <span class="badge bg-<%= car.condition === 'جديد' ? 'success' : 'primary' %>">
                                                <%= car.condition %>
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>لون السيارة:</strong></td>
                                        <td><%= car.color %></td>
                                    </tr>
                                    <tr>
                                        <td><strong>المحرك:</strong></td>
                                        <td><%= car.engine %></td>
                                    </tr>
                                    <tr>
                                        <td><strong>عدد المقاعد:</strong></td>
                                        <td><%= car.seats %></td>
                                    </tr>
                                    <tr>
                                        <td><strong>المشاهدات:</strong></td>
                                        <td><%= car.views %></td>
                                    </tr>
                                    <tr>
                                        <td><strong>تاريخ الإضافة:</strong></td>
                                        <td><%= new Date(car.dateAdded).toLocaleDateString('ar-SA') %></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        <% if (car.description) { %>
                            <hr>
                            <h6 class="text-muted">الوصف</h6>
                            <p class="text-justify"><%= car.description %></p>
                        <% } %>
                        
                        <% if (car.features && car.features.length > 0) { %>
                            <hr>
                            <h6 class="text-muted">المميزات</h6>
                            <div class="row">
                                <% car.features.forEach(function(feature) { %>
                                    <div class="col-md-4 mb-2">
                                        <i class="fas fa-check text-success me-2"></i>
                                        <%= feature %>
                                    </div>
                                <% }); %>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
            
            <!-- Seller Info & Contact -->
            <div class="col-lg-4">
                <!-- Price Card -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white text-center">
                        <h3 class="mb-0">
                            <%= new Intl.NumberFormat('ar-SA').format(car.price) %> <%= car.currency %>
                        </h3>
                    </div>
                    <div class="card-body text-center">
                        <p class="text-muted mb-3">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            <%= car.location.city %>, <%= car.location.country %>
                        </p>
                        
                        <% if (user && car.seller && car.seller._id.toString() === user._id.toString()) { %>
                            <!-- Owner Options -->
                            <div class="d-grid gap-2">
                                <a href="/cars/<%= car._id %>/edit" class="btn btn-warning">
                                    <i class="fas fa-edit me-2"></i>
                                    تعديل الإعلان
                                </a>
                                <button class="btn btn-danger" onclick="deleteCar()">
                                    <i class="fas fa-trash me-2"></i>
                                    حذف الإعلان
                                </button>
                            </div>
                        <% } else { %>
                            <!-- Contact Options -->
                            <div class="d-grid gap-2">
                                <% if (car.seller && car.seller.phone) { %>
                                    <a href="tel:<%= car.seller.phone %>" class="btn btn-success">
                                        <i class="fas fa-phone me-2"></i>
                                        اتصل الآن
                                    </a>
                                <% } %>
                                
                                <% if (car.seller && car.seller.whatsapp) { %>
                                    <a href="https://wa.me/<%= car.seller.whatsapp %>" target="_blank" class="btn btn-success">
                                        <i class="fab fa-whatsapp me-2"></i>
                                        واتساب
                                    </a>
                                <% } %>
                                
                                <% if (car.seller && car.seller.email) { %>
                                    <a href="mailto:<%= car.seller.email %>" class="btn btn-primary">
                                        <i class="fas fa-envelope me-2"></i>
                                        إرسال إيميل
                                    </a>
                                <% } %>
                            </div>
                        <% } %>
                    </div>
                </div>
                
                <!-- Seller Info -->
                <% if (car.seller) { %>
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">معلومات البائع</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0"><%= car.seller.firstName %> <%= car.seller.lastName %></h6>
                                    <small class="text-muted">عضو منذ <%= new Date(car.seller.dateRegistered).toLocaleDateString('ar-SA') %></small>
                                </div>
                            </div>
                            
                            <% if (car.seller.location) { %>
                                <p class="text-muted mb-2">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    <%= car.seller.location.city %>, <%= car.seller.location.country %>
                                </p>
                            <% } %>
                            
                            <a href="/users/<%= car.seller._id %>" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-user me-1"></i>
                                عرض الملف الشخصي
                            </a>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
        
        <!-- Related Cars -->
        <div class="mt-5">
            <h4 class="mb-4">سيارات مماثلة</h4>
            <div class="row">
                <!-- This would be populated with related cars -->
                <div class="col-12">
                    <p class="text-muted">لا توجد سيارات مماثلة حالياً</p>
                </div>
            </div>
        </div>
        
    <% } else { %>
        <div class="text-center py-5">
            <i class="fas fa-exclamation-triangle fa-5x text-warning mb-4"></i>
            <h3>السيارة غير موجودة</h3>
            <p class="text-muted">السيارة التي تبحث عنها غير متاحة أو تم حذفها</p>
            <a href="/cars" class="btn btn-primary">
                <i class="fas fa-arrow-right me-2"></i>
                العودة إلى قائمة السيارات
            </a>
        </div>
    <% } %>
</div>

<script>
function deleteCar() {
    if (confirm('هل أنت متأكد من حذف هذا الإعلان؟')) {
        fetch('/cars/<%= car._id %>', {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                alert('تم حذف الإعلان بنجاح');
                window.location.href = '/cars';
            } else {
                alert('حدث خطأ أثناء حذف الإعلان');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء حذف الإعلان');
        });
    }
}
</script>

<%- include('../partials/footer-content') %>
<%- include('../partials/footer') %>
